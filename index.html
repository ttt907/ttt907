<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コード出力</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            text-align: center;
            background-color: #f0f4f8;
            color: #333;
            padding: 20px;
        }

        h1 { color: #2c3e50; margin-bottom: 30px; }

        .main-layout {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 40px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        button {
            width: 200px; padding: 12px; font-size: 16px;
            cursor: pointer; background-color: #3498db; color: white;
            border: none; border-radius: 5px; transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover { background-color: #2980b9; }
        .btn-all { background-color: #e67e22; }

        .auto-control-area {
            display: flex; flex-direction: column;
            align-items: center; gap: 15px; width: 150px;
        }

        .btn-auto {
            width: 80px; height: 80px; border-radius: 50%;
            background-color: #95a5a6; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: none; color: white; cursor: pointer;
        }

        .btn-auto.active {
            background-color: #2ecc71;
            box-shadow: 0 0 15px #2ecc71;
            animation: pulse 1s infinite;
        }

        .tempo-slider-container {
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
        }

        .tempo-label {
            font-size: 14px; font-weight: bold; color: #2c3e50;
            background: #ecf0f1; padding: 4px 10px; border-radius: 10px;
        }

        /* サウンドON/OFFボタン */
        .btn-sound {
            width: 120px; padding: 8px; font-size: 12px;
            background-color: #bdc3c7; color: #2c3e50;
            border-radius: 20px; font-weight: bold;
        }
        .btn-sound.on {
            background-color: #f1c40f; color: #000;
        }

        #result-container {
            display: flex; justify-content: center; flex-wrap: wrap;
            gap: 20px; max-width: 700px; margin: 0 auto;
        }

        .chord-box {
            background-color: white; border: 3px solid #2c3e50;
            border-radius: 12px; width: 130px; height: 100px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    </style>
</head>
<body>

    <h1>コード出力</h1>

    <div class="main-layout">
        <div class="button-container">
            <button onclick="setMode('maj')">maj</button>
            <button onclick="setMode('maj+min')">maj+min</button>
            <button onclick="setMode('maj+min+7')">maj+min+7</button>
            <button onclick="setMode('maj+min+7+#')">maj+min+7+#</button>
            <button onclick="setMode('maj+min+7+#+♭')">maj+min+7+#+♭</button>
            <button onclick="setMode('all')" class="btn-all">all</button>
        </div>

        <div class="auto-control-area">
            <button id="autoBtn" class="btn-auto" onclick="toggleAuto()">auto</button>
            <div class="tempo-slider-container">
                <input type="range" id="tempoSlider" min="1" max="3" step="1" value="2" oninput="updateTempo()">
                <div id="tempoDisplay" class="tempo-label">Moderato</div>
            </div>
            <button id="soundBtn" class="btn-sound on" onclick="toggleSound()">SOUND: ON</button>
        </div>
    </div>

    <div id="result-container">
        <div style="color: #7f8c8d;">ボタンを押してスタート</div>
    </div>

    <script>
        const rootsNatural = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const rootsSharp   = ['C#', 'D#', 'F#', 'G#', 'A#'];
        const rootsFlat    = ['D♭', 'E♭', 'G♭', 'A♭', 'B♭'];
        const qualityMaj = [''];
        const qualityMin = ['m'];
        const quality7   = ['7', 'M7', 'm7'];
        const qualitySpecial = ['sus4', '7sus4', 'aug', 'dim', 'dim7', '6', 'm6', 'add9', '9', 'mM7', 'm7-5'];

        let isAuto = false;
        let isSoundOn = true;
        let currentType = '';
        let audioCtx = null;
        let nextNoteTime = 0.0;
        let beatInBar = 0;
        let timerID = null;

        const tempos = {
            '1': { label: 'Adagio', bpm: 65 },
            '2': { label: 'Moderato', bpm: 100 },
            '3': { label: 'Allegro', bpm: 150 }
        };

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('soundBtn');
            if (isSoundOn) {
                btn.innerText = "SOUND: ON";
                btn.classList.add('on');
                initAudio(); // 念のため初期化
            } else {
                btn.innerText = "SOUND: OFF";
                btn.classList.remove('on');
            }
        }

        function playClick(time, frequency) {
            if (!isSoundOn) return; // 音がOFFなら何もしない
            
            const osc = audioCtx.createOscillator();
            const envelope = audioCtx.createGain();

            osc.type = 'square';
            osc.frequency.value = frequency;

            envelope.gain.setValueAtTime(0.1, time);
            envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.1);

            osc.connect(envelope);
            envelope.connect(audioCtx.destination);

            osc.start(time);
            osc.stop(time + 0.1);
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                const bpm = tempos[document.getElementById('tempoSlider').value].bpm;
                const secondsPerBeat = 60.0 / bpm;

                playClick(nextNoteTime, beatInBar === 0 ? 1000 : 600);

                if (beatInBar === 0 && currentType) {
                    generateChords();
                }

                nextNoteTime += secondsPerBeat;
                beatInBar = (beatInBar + 1) % 4;
            }
            timerID = setTimeout(scheduler, 25);
        }

        function toggleAuto() {
            initAudio();
            isAuto = !isAuto;
            const btn = document.getElementById('autoBtn');
            if (isAuto) {
                btn.classList.add('active');
                nextNoteTime = audioCtx.currentTime;
                beatInBar = 0;
                scheduler();
            } else {
                btn.classList.remove('active');
                clearTimeout(timerID);
                beatInBar = 0;
            }
        }

        function updateTempo() {
            const val = document.getElementById('tempoSlider').value;
            document.getElementById('tempoDisplay').innerText = tempos[val].label;
        }

        function setMode(type) {
            currentType = type;
            if (!isAuto) generateChords();
        }

        function generateChords() {
            let activeRoots = [...rootsNatural];
            let activeQualities = [...qualityMaj];

            if (currentType === 'maj+min') activeQualities = activeQualities.concat(qualityMin);
            else if (currentType === 'maj+min+7') activeQualities = activeQualities.concat(qualityMin, quality7);
            else if (currentType === 'maj+min+7+#') { activeRoots = activeRoots.concat(rootsSharp); activeQualities = activeQualities.concat(qualityMin, quality7); }
            else if (currentType === 'maj+min+7+#+♭') { activeRoots = activeRoots.concat(rootsSharp, rootsFlat); activeQualities = activeQualities.concat(qualityMin, quality7); }
            else if (currentType === 'all') { activeRoots = activeRoots.concat(rootsSharp, rootsFlat); activeQualities = activeQualities.concat(qualityMin, quality7, qualitySpecial); }

            let pool = [];
            activeRoots.forEach(r => activeQualities.forEach(q => pool.push(r + q)));

            let selectedChords = [];
            let tempPool = [...pool];
            for (let i = 0; i < 4; i++) {
                if (tempPool.length === 0) break;
                selectedChords.push(tempPool.splice(Math.floor(Math.random() * tempPool.length), 1)[0]);
            }

            const resultContainer = document.getElementById('result-container');
            resultContainer.innerHTML = '';
            selectedChords.forEach(name => {
                const div = document.createElement('div');
                div.className = 'chord-box';
                div.innerText = name;
                resultContainer.appendChild(div);
            });
        }
    </script>
</body>
</html>
